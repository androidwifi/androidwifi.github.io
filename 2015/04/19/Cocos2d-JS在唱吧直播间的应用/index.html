<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Cocos2d-JS在直播间中的应用 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="直播间选用Cocos2d-JS作为礼物动画特效, 座驾等在Android, IOS, Web端的实现引擎">
<meta property="og:type" content="article">
<meta property="og:title" content="Cocos2d-JS在直播间中的应用">
<meta property="og:url" content="http://yoursite.com/2015/04/19/Cocos2d-JS在唱吧直播间的应用/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="直播间选用Cocos2d-JS作为礼物动画特效, 座驾等在Android, IOS, Web端的实现引擎">
<meta property="og:image" content="http://7xio0x.com1.z0.glb.clouddn.com/cocos2d_live_project_overview.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Cocos2d-JS在直播间中的应用">
<meta name="twitter:description" content="直播间选用Cocos2d-JS作为礼物动画特效, 座驾等在Android, IOS, Web端的实现引擎">
  
    <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="q" value="site:http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Cocos2d-JS在唱吧直播间的应用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/04/19/Cocos2d-JS在唱吧直播间的应用/" class="article-date">
  <time datetime="2015-04-19T12:47:22.000Z" itemprop="datePublished">2015-04-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Cocos2d-JS在直播间中的应用
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="(一)_Cocos2d-JS概述">(一) Cocos2d-JS概述</h2><h3 id="JS版本简介">JS版本简介</h3><p>Cocos2d-JS 是跨全平台的游戏引擎，采用原生JavaScript语言，可发布到各个平台，这个引擎是基于MIT开源协议，完全开源，免费，社区支持也比较活跃 Cocos2d-JS是Cocos2d-x的JavaScript版本，引擎融合了HTML5和JSB(Cocos2d-x JavaScript Bindings)。 它支持Cocos2d-x的所有核心特性并提供更简单易用的JavaScript风格API，基于Cocos2d-JS的框 架，可以方便用JS语言开发, 调试, 运行. 并且 Cocos2d-html5的API和Cocos2d-x JSB的API高度一致，少修改代码就可成为原生性能的混合游戏.</p>
<h3 id="此引擎的优势">此引擎的优势</h3><h4 id="1-_跨平台能力强">1. 跨平台能力强</h4><p>   和其他Cocos2d分支相比, 这个引擎几乎支持所有目前流行的桌面及移动平台.</p>
<h4 id="2-_功能强大高效">2. 功能强大高效</h4><p>   移植了Cocos2d-x功能, HTML5的游戏可以有原生性能, 新版本中特性更多.</p>
<h4 id="3-_高开发效率">3. 高开发效率</h4><p>   提供的API易学易用, 可在浏览器中调试, 然后部署到各个平台.</p>
<p>基于以上特性, 为支持主播端, IOS和Android客户端一致的功能和流畅的体验, 并且能高效迅速的开发, 直播间选用此游戏引擎作为礼物动画, 座驾等的开发框架. </p>
<h2 id="(二)_Cocos2d-JS开发及部署">(二) Cocos2d-JS开发及部署</h2><p>目前线上的引擎版本是3.0, 4月初官网发布了3.5版本, 目前直播团队正在做向3.3的升级. 引擎可以从官网直接下载, 压缩包解压即可.</p>
<p>目前开发工程叫<a href="ssh://git@cloud.zuitao-inc.com:10200/opt/git/ShowAnimation.git" target="_blank" rel="external">ShowAnimation</a>,  其中的mater分支是开发分支, 然后部署到各个平台, toots分支里主要包含了一些打包部署的工具.</p>
<h3 id="开发工具及环境搭建">开发工具及环境搭建</h3><h3 id="直播间动画工程">直播间动画工程</h3><p>打开ShowAnimation(或则新建的工程)的项目结构可以看到以下结构:</p>
<p><img src="http://7xio0x.com1.z0.glb.clouddn.com/cocos2d_live_project_overview.png" alt="Project Overview"></p>
<table>
<thead>
<tr>
<th style="text-align:left">工程文件</th>
<th style="text-align:left">功能描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">frameworks</td>
<td style="text-align:left">Cocos2d-JS引擎的目录, 包含Web引擎以及Native引擎, 其中cocos2d-html5是Web引擎, js-bindings是Cocos2d-x引擎以及JSB框架, 这个若不需要做性能优化或则裁剪一般不需要修改, runtime-src是新建一个工程后自动生成的项目的各平台工程文件，在部署时使用.</td>
</tr>
<tr>
<td style="text-align:left">publish</td>
<td style="text-align:left">该目录初始状态下不存在，当工程以发布模式打包后，会创建该文件夹并保存对应平台的发布包.</td>
</tr>
<tr>
<td style="text-align:left">res</td>
<td style="text-align:left">项目资源文件夹，应该用来存储所有图片，音频，字体，动画等资源, 例如礼物各帧图片, 座驾帧图片均放在此处.</td>
</tr>
<tr>
<td style="text-align:left">src</td>
<td style="text-align:left">项目脚本文件夹，应该用来存储所有直播动画需要的JavaScript代码, 这个是主要需要coding的地方,各种逻辑控制, API调用等等均在此处完成.</td>
</tr>
<tr>
<td style="text-align:left">index.html</td>
<td style="text-align:left">Web工程的主页面，通过本地服务器访问这个页面即可看到动画效果, 这个也是在webstorm中使用浏览器调试的入口.</td>
</tr>
<tr>
<td style="text-align:left">main.js</td>
<td style="text-align:left">动画入口文件，其中包含礼物动画初始化代码以及启动代码.</td>
</tr>
<tr>
<td style="text-align:left">project.json</td>
<td style="text-align:left">工程配置文件，详细配置方法可参考main.js中的注释 .</td>
</tr>
</tbody>
</table>
<p>启动为: <strong>进入main.js</strong>——&gt;<strong>加载引擎相关脚本</strong>——&gt;<strong>用户JS脚本</strong>—-&gt;<strong>根据系统和平台相关信息初始化渲染器</strong>——&gt;<strong>cc.director启动</strong></p>
<h3 id="各平台部署">各平台部署</h3><ul>
<li><p>客户端<br>对于IOS和Android, 执行如下命令可以生成相应的cocos2d引擎库(比如android是libcocos2djs.so), 集成到相应的客户端引用外部类库目录中, 另外, 需要把以上web分支中的src, res目录内容, main.js和project.json全部copy到客户端相应target目录内(如android的target是工程中的assets目录)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cocos compile -p web | android | ios</span><br></pre></td></tr></table></figure>
</li>
<li><p>主播端<br>主播端只需要直接把以上工程的所有文件部署到服务器上,  唯一不同的是, 需要把每个动画所需的各帧图片使用tools目录里面的工具合并成一幅图和一个.plist的清单文件.也可使用通过下面命令生成的publish文件夹部署到服务器上.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cocos compile -p web -m release</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="(三)_Cocos2d-JS性能优化及裁剪">(三) Cocos2d-JS性能优化及裁剪</h2><h3 id="主播端性能优化">主播端性能优化</h3><p> 在主播端上线后, 曾发现严重问题,   一旦加载礼物动画, 占用系统资源(CPU, 内存)就会上升到很高地步, cpu甚至达到了100%, 先后采取了以下方式解决:</p>
<ul>
<li>关掉debugMode, 具体是在project.json做如下更改<blockquote>
<p>“debugMode” : 0</p>
</blockquote>
</li>
</ul>
<p>优点: <em>更改简单, 只需要配置参数即可</em><br>缺点: <em>性能优化不明显, 资源下降程度不大, 大致下降了10%左右.</em></p>
<ul>
<li>改变浏览器的渲染模式,默认值为0, 改成2(只使用webgl方式渲染), 同样是在project.json更改<blockquote>
<p> “renderMode” : 2</p>
</blockquote>
</li>
</ul>
<p>优点: <em>优化明显, 性能下降20%~30%</em><br> 缺点: <em>需要Firfox浏览器手动打开webgl配置, 主播忘记或则不知如何打开时此法无效</em></p>
<ul>
<li>升级引擎版本<br> 目前采取的方案是升级web引擎从3.0到3.3, 据实测, 性能大幅度提升.</li>
</ul>
<h3 id="客户端安装包裁剪">客户端安装包裁剪</h3><p>部署方式生成的每个引擎库大约18M, 最后打到客户端安装包里面也占10M以上, 这大大增加了安装包的体积, 会产生一系列的推广和使用问题, 实际上对于android最终的线上APK来说, 已经达到33M之多了. 所以减少引擎库的大小成为降低安装包大小的重中之重.<br>经过不断的尝试, 大致采取了以下的方式来裁剪库的体积.</p>
<ul>
<li><p>生成Release版本<br>主要是在编译时去掉不必要的各种调试信息, 做法是在上面的编译命令时加上release选项, 最终打出来的库大约能减少4-6M的小, 此法一般作为方法2辅助手段而实施.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cocos -p android -m release</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改相应模块的编译脚本<br>上文提到, frameworks中主要有Cocos2d-html5引擎和Cocos2d-x引擎, 前者供html游戏使用,  后则为了本地应用如android等使用.因此, 只对后者的各模块裁剪.<br>出发点是对于直播间动画部分未用到的模块, 在编译引擎时不要编入, 这部分包括外部spinderMonkey预编译库和Bindings. 各个部分均用C++实现, 裁剪主要针对C++的编译makefile脚本及少量C文件进行.</p>
<blockquote>
<p><strong>frameworks/runtime-src/Classes/AppDelegate.cpp</strong>只保留以下模块的注册:</p>
</blockquote>
<pre><code>sc-&gt;addRegisterCallback<span class="list">(<span class="keyword">register_all_cocos2dx</span>)</span><span class="comment">;</span>
sc-&gt;addRegisterCallback<span class="list">(<span class="keyword">register_cocos2dx_js_core</span>)</span><span class="comment">;</span>
sc-&gt;addRegisterCallback<span class="list">(<span class="keyword">register_cocos2dx_js_extensions</span>)</span><span class="comment">;</span>
sc-&gt;addRegisterCallback<span class="list">(<span class="keyword">jsb_register_system</span>)</span><span class="comment">;</span>
</code></pre></li>
</ul>
<blockquote>
<p><strong>对于.mk系列文件</strong></p>
<ol>
<li>frameworks/js-bindings/cocos2d-x/extensions/Android.mk移调和GUI相关的模块</li>
<li>frameworks/js-bindings/cocos2d-x/cocos/ui/Android.mk 保留核心的Layout, shaders,scale, helper</li>
<li>frameworks/js-bindings/cocos2d-x/cocos/Android.mk 移调physics, 只加载ui, extension外部静态库</li>
<li>frameworks/js-bindings/cocos2d-x/cocos/base/ccConfig.h 更改CC_USE_PHYSICS为0, 用到此变量地方也要相应修改.</li>
</ol>
</blockquote>
<h2 id="(四)_后续新功能">(四) 后续新功能</h2><p>基于直播间动画有版本上线后继续添加礼物或则座驾的需求,  动态更新后续会加进来.</p>
<ul>
<li>程序的动态更新<br> 支持此功能最重要的类是AssetsManager, 其会先检查version.manifest，判断是否有更新。如果有，再拉取project.manifest, 这里面有欲获取资源文件的url地址,下载到本地资源目录后读取.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/04/19/Cocos2d-JS在唱吧直播间的应用/" data-id="cjapjwtm3000mnpwan0ggnytx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cocos2d-js/">cocos2d-js</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/05/13/FFMPEG-Summary/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          FFMPEG Summary
        
      </div>
    </a>
  
  
    <a href="/2015/04/19/ResumeSample1/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Resume sample</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Design/">Design</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jobs/">Jobs</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tools/">Tools</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebRTC/">WebRTC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cocos2d-js/">cocos2d-js</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/live-pusher/">live-pusher</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Design/" style="font-size: 10px;">Design</a><a href="/tags/Git/" style="font-size: 10px;">Git</a><a href="/tags/Jobs/" style="font-size: 20px;">Jobs</a><a href="/tags/Tools/" style="font-size: 10px;">Tools</a><a href="/tags/WebRTC/" style="font-size: 10px;">WebRTC</a><a href="/tags/cocos2d-js/" style="font-size: 20px;">cocos2d-js</a><a href="/tags/live-pusher/" style="font-size: 10px;">live-pusher</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/12/03/升级FFMPEG/">升级FFMPEG</a>
          </li>
        
          <li>
            <a href="/2017/09/02/The-stragedy-of-breaking-GFW/">The stragedy of breaking GFW</a>
          </li>
        
          <li>
            <a href="/2017/09/02/Ubuntu-上下载webrtc-编译android版本/">Ubuntu 上下载webrtc , 编译android版本</a>
          </li>
        
          <li>
            <a href="/2017/03/19/Android推流在小米4内存上涨问题解决/">Android推流在小米4内存上涨问题解决</a>
          </li>
        
          <li>
            <a href="/2015/12/16/使用submodule来管理公共依赖工程/">使用submodule来管理公共依赖工程</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>